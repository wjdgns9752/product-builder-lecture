<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="웹에서 바로 사용하는 실시간 환경 소음 측정기 (층간소음, 항공기, 도로, 철도). 데시벨(dB) 측정, 소음 기록 저장, 분야별 법적 기준 정보를 제공합니다. 별도의 설치 없이 마이크로 간편하게 측정하세요.">
    <meta name="keywords" content="소음 측정기, 층간소음, 항공기 소음, 도로교통 소음, 철도 소음, 데시벨 측정, 소음 기준">
    <meta property="og:title" content="스마트 환경 소음 모니터 - 실시간 데시벨 측정">
    <meta property="og:description" content="설치 없는 무료 소음 측정기. 층간소음, 항공기, 교통 소음 기록 및 분석 기능을 제공합니다.">
    <meta property="og:type" content="website">
    
    <title>스마트 환경 소음 모니터 (층간/항공/도로/철도) | 실시간 dB 측정</title>
    
    <!-- Firebase (Compat/UMD) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- UI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="style.css?v=20">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔊</text></svg>">
    
    <!-- Google AdSense -->
    <meta name="google-adsense-account" content="ca-pub-4494575673591119">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4494575673591119"
     crossorigin="anonymous"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NWVHVCQJFB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NWVHVCQJFB');
    </script>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "v3nju6xrp9");
    </script>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">🔊 Environmental Noise Monitor</div>
            <div id="user-status-container" style="font-size: 0.9rem;">
                <span id="user-nickname-display" style="font-weight: bold; color: var(--primary-color);">Guest</span> 님
            </div>
        </div>
    </header>

    <main class="container">
        
        <!-- === VIEW 1: MONITOR (Main) === -->
        <div id="view-monitor" class="view active">
            <section class="tool-section">
                <h1>실시간 환경 소음 모니터링</h1>
                <p class="subtitle">AI 기반 소음원 분석 및 실시간 측정</p>
                
                <canvas id="visualizer" width="600" height="100"></canvas>
                
                <!-- Noise Classification UI -->
                <div class="classifier-container">
                    <h3>🔍 AI 소음원 분석 (YAMNet)</h3>
                    
                    <div class="class-grid" id="ai-grid">
                        <div class="class-card" id="card-home">
                            <div class="icon">🏠</div>
                            <div class="label">생활소음</div>
                        </div>
                        <div class="class-card" id="card-floor">
                            <div class="icon">👣</div>
                            <div class="label">층간소음</div>
                        </div>
                        <div class="class-card" id="card-road">
                            <div class="icon">🚗</div>
                            <div class="label">도로교통</div>
                        </div>
                        <div class="class-card" id="card-train">
                            <div class="icon">🚆</div>
                            <div class="label">철도/지하철</div>
                        </div>
                        <div class="class-card" id="card-air">
                            <div class="icon">✈️</div>
                            <div class="label">항공기</div>
                        </div>
                        <div class="class-card active" id="card-none">
                            <div class="icon">⏸️</div>
                            <div class="label">대기 중</div>
                        </div>
                    </div>
    
                    <div id="ai-status-bar" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px; font-size: 0.85rem; color: #555;">
                        <span id="ai-loader">⏳ AI 모델 준비 중...</span>
                        <div id="ai-meter" style="height: 4px; background: #ddd; margin-top: 5px; border-radius: 2px; overflow: hidden;">
                            <div id="ai-meter-fill" style="width: 0%; height: 100%; background: var(--primary-color); transition: width 0.2s;"></div>
                        </div>
                        <div id="ai-result-text" style="margin-top: 5px; font-weight: bold; color: var(--primary-color);"></div>
                    </div>
                </div>
                
                <div class="status-panel">
                    <h2 id="status-text">상태: 대기 중</h2>
                    
                    <div class="info-text">
                        <span>현재: <span id="current-vol">0</span> dB</span>
                        <span>배경: <span id="bg-vol">0</span> dB</span>
                    </div>
                    
                    <div class="meter-container">
                        <div id="bg-marker"></div>
                        <div id="meter-bar"></div>
                    </div>
    
                    <div class="duration-container">
                        <div class="duration-label">지속 시간 감지</div>
                        <div class="duration-track">
                            <div id="duration-bar"></div>
                        </div>
                    </div>
                </div>
    
                    <div class="controls">
                        <button id="init-btn" class="primary-btn" onclick="window.startMonitoring()">모니터링 시작</button>
                        <button id="record-btn" class="record-btn hidden">🔴 녹음 시작</button>
                    </div>            </section>

            <!-- Harmonica Index (Summary) -->
            <div class="analysis-dashboard" style="margin-top: 20px;">
                <h3>📊 실시간 성향 분석 (Harmonica)</h3>
                <div class="metrics-grid">
                    <div class="metric-box">
                        <span class="m-label">배경 소음 (L90)</span>
                        <span class="m-value" id="val-l90">-</span>
                        <div class="m-desc">기본 소음</div>
                    </div>
                    <div class="metric-box highlight">
                        <span class="m-label">돌발 강도 (Event)</span>
                        <span class="m-value" id="val-event">-</span>
                        <div class="m-desc">체감 충격</div>
                    </div>
                    <div class="metric-box">
                        <span class="m-label">변동성 (Fluct)</span>
                        <span class="m-value" id="val-ir">-</span>
                        <div class="m-desc">변화폭</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW 2: ANALYSIS (Detailed + Dose Response) === -->
        <div id="view-analysis" class="view hidden">
            <section class="tool-section">
                <h2>📊 소음 정밀 분석</h2>
                
                <div class="metrics-grid">
                    <div class="metric-box">
                        <span class="m-label">배경 소음 (L90)</span>
                        <span class="m-value" id="val-l90">0.0</span>
                        <div class="m-desc">안정적인 기본 소음</div>
                    </div>
                    <div class="metric-box highlight">
                        <span class="m-label">돌발 강도</span>
                        <span class="m-value" id="val-event">0.0</span>
                        <div class="m-desc">순간적인 소음 충격</div>
                    </div>
                    <div class="metric-box">
                        <span class="m-label">최대 소음</span>
                        <span class="m-value" id="val-max">0.0</span>
                        <div class="m-desc">측정 중 최고 데시벨</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>😖 예상 불쾌감 (%HA)</h3>
                    <canvas id="doseResponseChart" style="height: 200px;"></canvas>
                    <div id="dose-result" style="margin-top:10px; font-size: 0.9rem; font-weight:bold;">
                        현재 불쾌감 지수: <span id="ha-percent" style="color:var(--accent-color);">0</span>%
                    </div>
                </div>

                <div class="analysis-comment-box">
                    <span id="noise-badge" class="badge">측정 필요</span>
                    <p id="analysis-comment">데이터를 분석 중입니다. 측정을 시작해 주세요.</p>
                </div>
            </section>
        </div>

        <!-- === VIEW 3: MAP (Noise Map) === -->
        <div id="view-map" class="view hidden">
            <section class="tool-section">
                <h2>🗺️ 실시간 소음 지도</h2>
                <p class="subtitle">이동 경로에 따른 소음 변화가 기록됩니다.</p>
                
                <div id="map-container" style="height: 350px; border-radius: 12px; margin: 15px 0;"></div>
                
                <div class="controls">
                    <button id="btn-update-location" class="secondary-btn">📍 현재 위치로 이동</button>
                    <button id="btn-clear-map" class="secondary-btn" style="border-color:#f44336; color:#f44336;">🗑️ 기록 삭제</button>
                </div>
            </section>
        </div>

        <!-- === VIEW 4: INFO (Settings & Guide) === -->
        <div id="view-info" class="view hidden">
            <section class="tool-section">
                <h2>⚙️ 설정 및 가이드</h2>
                
                <div class="settings">
                    <h3>알림 민감도 설정</h3>
                    <div class="slider-wrapper">
                        <input type="range" id="threshold" min="10" max="100" value="50">
                        <span id="threshold-val">50</span>%
                    </div>
                    <br>
                    <button id="calibration-btn" class="secondary-btn">🎙️ 마이크 보정 (Calibration)</button>
                    <br>
                    <label>
                        <input type="checkbox" id="audio-alarm" checked>
                        알림음 켜기
                    </label>
                    <button id="theme-toggle" class="theme-btn" style="margin-top:10px">테마 변경</button>
                </div>

                <div class="content-block" style="margin-top: 30px;">
                    <h3>🛠️ 정확한 측정을 위한 팁</h3>
                    <ol class="text-list">
                        <li><strong>마이크 보정:</strong> 기기마다 감도가 다릅니다. '보정' 기능을 꼭 사용하세요.</li>
                        <li><strong>위치:</strong> 소음원 방향으로 마이크를 향하게 하세요.</li>
                        <li><strong>배경음 학습:</strong> 시작 후 30초간 큰 소리를 내지 마세요.</li>
                    </ol>
                </div>

                <div class="content-block">
                    <h3>⚖️ 소음 기준 (요약)</h3>
                    <div class="standard-grid">
                        <div class="std-card">
                            <h4>층간소음</h4>
                            <div class="std-desc">공동주택 기준</div>
                            <ul>
                                <li>주간: 39dB</li>
                                <li>야간: 34dB</li>
                            </ul>
                        </div>
                        <div class="std-card">
                            <h4>도로교통</h4>
                            <div class="std-desc">주거지역</div>
                            <ul>
                                <li>주간: 68dB</li>
                                <li>야간: 58dB</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <footer style="padding:0; margin-top:20px;">
                    <a href="#" id="admin-mode-btn">관리자 모드</a>
                </footer>
            </section>
        </div>

    </main>

    <!-- Navigation Bar -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-target="view-monitor">
            <span class="icon">📊</span>
            <span>측정</span>
        </button>
        <button class="nav-item" data-target="view-analysis">
            <span class="icon">📈</span>
            <span>분석</span>
        </button>
        <button class="nav-item" data-target="view-map">
            <span class="icon">🗺️</span>
            <span>지도</span>
        </button>
        <button class="nav-item" data-target="view-info">
            <span class="icon">⚙️</span>
            <span>설정/정보</span>
        </button>
    </nav>

    <!-- Modals (Preserved) -->
    <div id="calibration-modal" class="modal hidden">
        <div class="modal-content">
            <h2>마이크 보정</h2>
            <p class="desc">정확한 측정을 위해 기준점을 설정합니다.</p>
            <div class="calib-step">
                <span class="step-num">1</span>
                <p>핑크 노이즈 재생 (선택)</p>
                <button id="play-noise-btn">🔊 핑크 노이즈 재생/중지</button>
            </div>
            <div class="calib-step">
                <span class="step-num">2</span>
                <button id="auto-calib-btn" class="primary-btn" style="width:100%">🚀 정밀 자동 보정 (3회)</button>
                <div class="calib-divider"><span>또는 수동 입력</span></div>
                <div class="input-group" style="justify-content: center;">
                    <input type="number" id="real-db-input" placeholder="60" min="30" max="120"> dB
                </div>
            </div>
            <div class="calib-step">
                <span class="step-num">3</span>
                <p>현재값: <span id="current-raw-db">...</span> dBFS</p>
            </div>
            <div class="btn-group">
                <button id="cancel-calib" class="secondary-btn">취소</button>
                <button id="save-calib" class="primary-btn">저장</button>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="modal hidden">
        <div class="modal-content">
            <h2>🛠️ 관리자 실험실</h2>
            <div class="survey-section" style="background: #f5f5f5; padding: 15px;">
                <div class="input-group" style="justify-content: space-between;">
                    <label>앱 측정값</label> <span id="admin-app-db" style="font-weight:bold;">0.0</span> dB
                </div>
                <div class="input-group" style="justify-content: space-between;">
                    <label>기준값</label> <input type="number" id="admin-ref-db" placeholder="65.5"> dB
                </div>
                <button id="admin-log-btn" class="primary-btn" style="width:100%; margin-top:15px;">기록</button>
            </div>
            <div style="max-height: 200px; overflow-y: auto; margin-top:20px;">
                <table style="width:100%">
                    <tbody id="admin-log-table"></tbody>
                </table>
            </div>
            <div style="text-align:right; margin-top:10px">MAE: <span id="admin-mae">0.0</span> dB</div>
            <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="secondary-btn">닫기</button>
        </div>
    </div>

    <!-- Evaluation Modal -->
    <div id="evaluation-modal" class="modal hidden">
        <div class="modal-content">
            <h2>소음 평가 (EMA)</h2>
            <div class="audio-preview-section" id="audio-preview-container" style="display:none;">
                <audio id="noise-player" controls style="width:100%"></audio>
                <a id="download-recording" href="#" class="secondary-btn">💾 다운로드</a>
            </div>
            <div class="survey-section">
                <label>불쾌감 (1-10)</label>
                <div class="rating-scale">
                    <button class="rate-btn" data-val="1">1</button>
                    <button class="rate-btn" data-val="2">2</button>
                    <button class="rate-btn" data-val="3">3</button>
                    <button class="rate-btn" data-val="4">4</button>
                    <button class="rate-btn" data-val="5">5</button>
                    <button class="rate-btn" data-val="6">6</button>
                    <button class="rate-btn" data-val="7">7</button>
                    <button class="rate-btn" data-val="8">8</button>
                    <button class="rate-btn" data-val="9">9</button>
                    <button class="rate-btn" data-val="10">10</button>
                </div>
            </div>
            <div class="survey-section">
                <label>활동</label>
                <div class="chip-group" id="activity-chips">
                    <button class="chip" data-type="activity" data-val="working">일/학습</button>
                    <button class="chip" data-type="activity" data-val="relaxing">휴식</button>
                    <button class="chip" data-type="activity" data-val="sleeping">수면</button>
                    <button class="chip" data-type="activity" data-val="housework">가사</button>
                </div>
            </div>
            <div class="survey-section">
                <label>소음원(정답)</label>
                <div class="chip-group" id="source-chips">
                    <button class="chip" data-type="source" data-val="footsteps">층간소음</button>
                    <button class="chip" data-type="source" data-val="traffic">도로</button>
                    <button class="chip" data-type="source" data-val="aircraft">항공</button>
                    <button class="chip" data-type="source" data-val="train">철도</button>
                    <button class="chip" data-type="source" data-val="voice">사람</button>
                </div>
            </div>
            <button id="submit-eval" disabled class="primary-btn" style="width:100%">제출</button>
        </div>
    </div>

    <!-- Auth & Onboarding Modals -->
    <div id="auth-modal" class="modal hidden" style="z-index: 2000;">
        <div class="modal-content">
            <h2>👋 환영합니다!</h2>
            <input type="text" id="auth-nickname" placeholder="닉네임 입력" style="width:100%; padding:10px; margin:20px 0;">
            <button id="btn-start" class="primary-btn" style="width:100%">시작하기</button>
        </div>
    </div>

    <div id="user-info-modal" class="modal hidden">
        <div class="modal-content">
            <h2>환경 정보</h2>
            <div id="user-info-form">
                <select id="housing-type" class="full-select">
                    <option value="apartment">아파트</option>
                    <option value="officetel">오피스텔</option>
                    <option value="villa">빌라</option>
                    <option value="house">주택</option>
                </select>
                <select id="floor-level" class="full-select">
                    <option value="low">저층</option>
                    <option value="mid">중층</option>
                    <option value="high">고층</option>
                </select>
                <select id="env-type" class="full-select">
                    <option value="residential">주택가</option>
                    <option value="roadside">도로변</option>
                    <option value="railway">철도변</option>
                    <option value="airport">공항인근</option>
                </select>
                <button onclick="saveUserInfo()" class="primary-btn" style="width:100%; margin-top:20px;">완료</button>
            </div>
        </div>
    </div>
    
    <div id="permission-modal" class="modal hidden" style="z-index: 2000;">
        <div class="modal-content">
            <h2>⚠️ 마이크 권한 필요</h2>
            <p>브라우저 설정에서 마이크를 허용해주세요.</p>
            <button onclick="location.reload()" class="primary-btn">새로고침</button>
        </div>
    </div>

    <!-- TFJS Core Only (No YAMNet Lib) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
</body>
</html>